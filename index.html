<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>Smart Minibus â€“ Nathan Road Demo</title>

  <!-- å¤–ç½® CSS -->
  <link rel="stylesheet" href="style.css">
</head>

<body>

<h1>ğŸšŒ Smart Minibus â€“ å½Œæ•¦é“ï¼ˆæ˜æ—¥è¿”å·¥ï¼‰</h1>

<p style="text-align:center;">
  é¸æ“‡ä¸Šè»Šé»ã€è½è»Šé»åŠå‡ºç™¼æ™‚é–“
</p>

<!-- Google Map -->
<div id="map" class="map-container"></div>

<div class="info-box">
  <div><strong>æ—¥æœŸï¼š</strong> æ˜æ—¥</div>

  <div>
    <strong>å‡ºç™¼æ™‚é–“ï¼š</strong>
    <select id="timeSelect" onchange="updateSeats()">
      <option value="">è«‹é¸æ“‡</option>
      <option value="08:30">08:30</option>
      <option value="08:45">08:45</option>
      <option value="09:00">09:00</option>
    </select>
  </div>

  <div><strong>å·²é¸ä¸Šè»Šé»ï¼š</strong> <span id="pickupText">æœªé¸æ“‡</span></div>
  <div><strong>å·²é¸è½è»Šé»ï¼š</strong> <span id="dropoffText">æœªé¸æ“‡</span></div>
  <div><strong>å‰©é¤˜åº§ä½ï¼š</strong> <span id="seatText">â€”</span></div>

  <button id="bookBtn" class="disabled" onclick="bookSeat()">é è¨‚åº§ä½</button>
  <div id="status" style="margin-top:8px;"></div>

  <div style="margin-top:10px;">
    <strong>å»ºè­°åœé é †åºï¼š</strong>
    <span id="routePlan">â€”</span>
  </div>
</div>

<script>
/* ========================
   ç³»çµ±ç‹€æ…‹
======================== */
let passengers = [];
let selectedPickup = null;
let selectedDropoff = null;
let selectedTime = "";

const stopOrder = {
  "ä½æ•¦": 1,
  "æŸ¯å£«ç”¸": 2,
  "å°–æ²™å’€": 3,
  "K11": 4
};

let routes = {
  "08:30": 20,
  "08:45": 20,
  "09:00": 20
};

let map;
let bounds;
let pickupMarker = null;
let dropoffMarker = null;

/* ========================
   Google Map åˆå§‹åŒ–
======================== */
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 15, // ä¹‹å¾Œæœƒè¢« fitBounds è¦†è“‹
    center: { lat: 22.3048, lng: 114.1717 }
  });

  bounds = new google.maps.LatLngBounds();

  /* ===== ä¸Šè»Šé» Pickup ===== */
  createMarker(
    { lat: 22.304800, lng: 114.171699 },
    "pickup",
    "ä½æ•¦ MTR"
  );

  createMarker(
    { lat: 22.301734218400927, lng: 114.17200865012487 },
    "pickup",
    "è–å®‰å¾·çƒˆå ‚"
  );

  createMarker(
    { lat: 22.306393051578773, lng: 114.17142374190861 },
    "pickup",
    "å—äº¬è¡— Ã— å½Œæ•¦é“"
  );

  createMarker(
    { lat: 22.307430657315873, lng: 114.17154245615282 },
    "pickup",
    "å½Œæ•¦é…’åº—"
  );

  /* ===== è½è»Šé» Dropoff ===== */
  createMarker(
    { lat: 22.297584, lng: 114.172175 },
    "dropoff",
    "å°–æ²™å’€ MTR"
  );

  createMarker(
    { lat: 22.299775483011146, lng: 114.17179910962814 },
    "dropoff",
    "æŸéº—è³¼ç‰©å¤§é“"
  );

  // â­â­â­ Task 3 æ ¸å¿ƒï¼šè‡ªå‹•èª¿æ•´è¦–é‡ â­â­â­
  map.fitBounds(bounds);
}

function createMarker(position, type, name) {
  const marker = new google.maps.Marker({
    position,
    map,
    label: type === "pickup" ? "P" : "D",
  });

  bounds.extend(position);
  
  marker.addListener("click", () => {
    if (type === "pickup") {
      selectPickup(marker, name);
    } else {
      selectDropoff(marker, name);
    }
  });
}

/* ========================
   é¸æ“‡é‚è¼¯
======================== */
function selectPickup(marker, name) {
  selectedPickup = marker;
  document.getElementById("pickupText").innerText = name;
  updateButton();
}

function selectDropoff(marker, name) {
  selectedDropoff = marker;
  document.getElementById("dropoffText").innerText = name;
  updateButton();
}

function updateSeats() {
  selectedTime = document.getElementById("timeSelect").value;
  document.getElementById("seatText").innerText =
    selectedTime ? routes[selectedTime] : "â€”";
  updateButton();
}

function updateButton() {
  const btn = document.getElementById("bookBtn");
  if (selectedPickup && selectedDropoff && selectedTime && routes[selectedTime] > 0) {
    btn.classList.remove("disabled");
  } else {
    btn.classList.add("disabled");
  }
}

/* ========================
   é è¨‚ & è·¯ç·š
======================== */
function bookSeat() {
  if (!selectedTime || routes[selectedTime] <= 0) return;

  routes[selectedTime]--;

  passengers.push({
    pickup: document.getElementById("pickupText").innerText,
    dropoff: document.getElementById("dropoffText").innerText
  });

  document.getElementById("seatText").innerText = routes[selectedTime];
  document.getElementById("status").innerText =
    "âœ… æˆåŠŸé è¨‚ " + selectedTime + " ç­æ¬¡";

  updateRoutePlan();
  updateButton();
}

function updateRoutePlan() {
  let stops = [];

  passengers.forEach(p => {
    if (!stops.includes(p.pickup)) stops.push(p.pickup);
    if (!stops.includes(p.dropoff)) stops.push(p.dropoff);
  });

  stops.sort((a, b) => stopOrder[a] - stopOrder[b]);
  document.getElementById("routePlan").innerText = stops.join(" â†’ ");
}
</script>

<!-- Google Maps APIï¼ˆä¸€å®šè¦æœ€å¾Œï¼‰ -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpEOmDko5uGXfIoCiQmGP-9Oi2Horo3IE&callback=initMap"
  async
  defer>
</script>

</body>
</html>